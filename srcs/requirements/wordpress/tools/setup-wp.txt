#!/bin/bash
set -e

# Warte bis MariaDB erreichbar ist
echo "Waiting for MariaDB to become available..."
for i in {1..30}; do
    if mariadb -h mariadb -P 3306 -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1" &> /dev/null; then
        echo "MariaDB is up!"
        break
    fi
    echo "Attempt $i/30: MariaDB not ready yet..."
    sleep 2
done
if [ $i -eq 30 ]; then
    echo "Error: MariaDB not available after 60 seconds!"
    exit 1
fi

WP_PATH="/var/www/wordpress"

# wp-cli installieren (falls noch nicht da)
if [ ! -f /usr/local/bin/wp ]; then
    echo "Installing wp-cli..."
    curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/v2.10.0/wp-cli.phar
    chmod +x wp-cli.phar
    mv wp-cli.phar /usr/local/bin/wp
fi

if [ ! -f "$WP_PATH/wp-config.php" ]; then
    echo "Configuring WordPress for the first time..."

    cp $WP_PATH/wp-config-sample.php $WP_PATH/wp-config.php

    sed -i "s/database_name_here/$MYSQL_DATABASE/" $WP_PATH/wp-config.php
    sed -i "s/username_here/$MYSQL_USER/"         $WP_PATH/wp-config.php
    sed -i "s/password_here/$MYSQL_PASSWORD/"     $WP_PATH/wp-config.php
    sed -i "s/localhost/mariadb/"                  $WP_PATH/wp-config.php

    # WordPress installieren + Admin + zweiter User
    wp core install --path=$WP_PATH \
    --url="$WP_URL" \
    --title="$WP_TITLE" \
    --admin_user="$WP_ADMIN_USER" \
    --admin_password="$(cat /run/secrets/wp_admin_password)" \
    --admin_email="$WP_ADMIN_EMAIL" \
    --allow-root

    wp user create "$WP_USER" "$WP_USER_EMAIL" \
    --role=author \
    --user_pass="$(cat /run/secrets/wp_user_password)" \
    --allow-root --path=$WP_PATH

    chown -R www-data:www-data $WP_PATH
fi

echo "WordPress is ready! Starting PHP-FPM..."

# Wichtig: Vollständiger Binary-Name für Debian Bookworm (php-fpm8.2 statt php-fpm)
exec /usr/sbin/php-fpm8.2 --nodaemonize